# 为了清晰起见，我们只展示需要修改和新增的部分
name: 1.Net Build and Release

on:
  workflow_dispatch:
    inputs:
      Reason:
        description: 'Reasons for temporary build'
        required: true
        default: 'No reason. Just do it.'
  push:
    # 通常只在打版本标签时创建 Release
    tags:
      - 'v*' # 当推送 v 开头的标签时触发，例如 v2.1
    branches:
      - master
    paths-ignore:
      - '**/*.md'
      - .gitignore
      - .editorconfig
      - appveyor.yml
  # 建议为 Release 构建移除 pull_request 触发器，或确保其不会创建 Release

jobs:
  build:
    name: Build (${{ matrix.BUILD_CONFIGURATION }})
    runs-on: windows-latest
    strategy:
      matrix:
        BUILD_CONFIGURATION: [Debug, Release]
    steps:
      # ... 前面的步骤（检出代码、安装MSBuild、恢复NuGet、构建）保持不变 ...
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RevokeMsgPatcher-${{ matrix.BUILD_CONFIGURATION }}
          path: |
            .\RevokeMsgPatcher\bin\${{ matrix.BUILD_CONFIGURATION }}\
            # 注意：这里可以根据需要调整具体要打包的文件路径
            # 确保路径指向构建输出的正确位置

  # 新增一个专门用于创建 Release 的 Job
  create-release:
    name: Create Release
    # 这个 Job 仅在构建 Job 成功，且是由标签触发时运行
    needs: build
    if: success() && startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    permissions:
      contents: write # 这是创建 Release 所必需的新权限

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Release Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: RevokeMsgPatcher-Release # 只下载 Release 版本的构件
          path: ./release-assets

      - name: List downloaded files
        run: dir .\release-assets /B
        shell: cmd

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }} # 使用触发工作流的标签
          name: Release ${{ github.ref_name }}
          # body: 这里可以写一些发布说明，可以从文件读取或直接填写
          generate_release_notes: true # 让 GitHub 自动生成发布说明
          files: |
            ./release-assets/**/*.exe
            ./release-assets/**/*.dll
            # 您可以在这里添加其他需要包含在 Release 中的文件模式
            # 例如，创建一个 ZIP 包
